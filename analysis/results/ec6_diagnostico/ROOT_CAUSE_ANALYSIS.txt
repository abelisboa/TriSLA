============================================================
ROOT CAUSE ANALYSIS - FASE EC.6
============================================================
Data: ter 02 dez 2025 15:08:54 -03

============================================================
ROOT CAUSE 1: ENDPOINT INCORRETO NO DECISION_ENGINE_URL
============================================================

Problema:
  - DECISION_ENGINE_URL configurado com: /evaluate
  - Decision Engine expõe endpoint: /api/v1/decide
  - Resultado: 404 Not Found

Evidências:
  - values-nasp.yaml: DECISION_ENGINE_URL = "http://10.233.59.75:8082/evaluate"
  - Decision Engine OpenAPI: endpoint /api/v1/decide existe
  - Logs SEM-CSMF: "404 Client Error: Not Found for url: .../evaluate"
  - Logs Decision Engine: "POST /evaluate HTTP/1.1" 404 Not Found

Impacto: CRÍTICO
  - SEM-CSMF não consegue comunicar com Decision Engine
  - Pipeline quebra em SEM-CSMF → Decision Engine
  - NEST gerado mas decisão não é processada

============================================================
ROOT CAUSE 2: DNS NÃO FUNCIONAL (JÁ CONTORNADO)
============================================================

Problema:
  - DNS do cluster não resolve service names
  - CoreDNS não responde queries

Evidências:
  - nslookup kubernetes.default: FALHOU
  - nslookup trisla-decision-engine: FALHOU
  - Workaround IP direto já aplicado: 10.233.59.75

Impacto: MODERADO (já contornado)
  - Workaround IP direto funciona
  - Conectividade via IP OK
  - Problema é de infraestrutura do cluster

============================================================
ROOT CAUSE 3: DECISION ENGINE TAG DESATUALIZADA
============================================================

Problema:
  - Decision Engine rodando v3.7.0-nasp
  - Deveria ser v3.7.2-nasp para alinhamento

Evidências:
  - values-nasp.yaml: tag: "v3.7.0-nasp"
  - Pod rodando: ghcr.io/abelisboa/trisla-decision-engine:v3.7.0-nasp

Impacto: BAIXO
  - Não é causa do problema atual (404)
  - Mas pode causar incompatibilidades futuras

============================================================
ROOT CAUSE 4: TEMPLATE HELM COM DECISION_ENGINE_URL DUPLICADO
============================================================

Problema:
  - deployment-sem-csmf.yaml tem DECISION_ENGINE_URL duplicado
  - Pode causar comportamento inesperado

Evidências:
  - Template mostra 2 blocos {{- if .Values.semCsmf.env.DECISION_ENGINE_URL }}
  - Um após OTLP_ENDPOINT

Impacto: BAIXO
  - Não impede funcionamento
  - Mas deve ser corrigido para limpeza

============================================================
RESUMO DOS ROOT CAUSES
============================================================

CRÍTICO:
  1. Endpoint incorreto: /evaluate → deve ser /api/v1/decide

MODERADO (já contornado):
  2. DNS não funcional → workaround IP direto aplicado

BAIXO:
  3. Decision Engine tag desatualizada → v3.7.0 vs v3.7.2
  4. Template Helm com duplicação → limpeza necessária

============================================================
AÇÃO RECOMENDADA
============================================================

1. Corrigir DECISION_ENGINE_URL para usar /api/v1/decide
2. Manter workaround IP direto (DNS quebrado)
3. Atualizar Decision Engine para v3.7.2-nasp (opcional)
4. Limpar template Helm (remover duplicação)

============================================================
