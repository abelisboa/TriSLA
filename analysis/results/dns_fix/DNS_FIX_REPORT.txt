========================================================
DNS FIX REPORT - TriSLA v3.7.2-nasp-fix
========================================================
Data: ter 02 dez 2025 14:37:15 -03
Ambiente: NASP (node1)
Namespace: trisla

========================================================
1. STATUS DNS
========================================================

Status: NOK - DNS não está funcionando corretamente

Pods CoreDNS:
  - coredns-7545f74586-42q7l: Running (1/1) - node1
  - coredns-7545f74586-xnscb: Running (1/1) - node2

Ação realizada: CoreDNS reiniciado (rollout restart)

========================================================
2. PROBLEMAS IDENTIFICADOS
========================================================

CRÍTICO:
1. DNS não resolve service names dentro dos pods
   - nslookup falha: connection timed out; no servers could be reached
   - Testado: trisla-decision-engine.trisla.svc.cluster.local
   - Testado: kubernetes.default.svc.cluster.local
   - Ambos falharam

2. Resolução DNS falha no pod SEM-CSMF
   - socket.gaierror: [Errno -3] Temporary failure in name resolution
   - getent hosts falha
   - socket.gethostbyname falha

3. Logs CoreDNS mostram problemas:
   - Certificados expirados (x509: certificate has expired)
   - Timeouts em queries externas
   - Problemas de autenticação com API server

POSITIVO:
4. Conexão via IP direto funciona
   - IP do Decision Engine: 10.233.59.75
   - curl http://10.233.59.75:8082/health retorna: OK
   - Health check do Decision Engine responde corretamente

========================================================
3. RESULTADO DOS TESTES
========================================================

Teste 1 - nslookup trisla-decision-engine.trisla.svc.cluster.local:
  Resultado: FALHOU
  Erro: connection timed out; no servers could be reached

Teste 2 - nslookup kubernetes.default.svc.cluster.local:
  Resultado: FALHOU
  Erro: connection timed out; no servers could be reached

Teste 3 - Resolução DNS no pod SEM-CSMF:
  Resultado: FALHOU
  Erro: socket.gaierror: [Errno -3] Temporary failure in name resolution

Teste 4 - Curl via IP direto (10.233.59.75:8082/health):
  Resultado: SUCESSO
  Resposta: {status:healthy,module:decision-engine,...}

Teste 5 - Curl via DNS (trisla-decision-engine.trisla.svc.cluster.local:8082/health):
  Resultado: FALHOU
  Erro: URLError: [Errno -3] Temporary failure in name resolution

========================================================
4. EVIDÊNCIAS
========================================================

1. CoreDNS está rodando mas não está respondendo queries
2. Pods não conseguem resolver nomes de services
3. Conexão direta via IP funciona (rede OK)
4. Problema é específico de DNS/resolução de nomes

Causa provável:
- Configuração incorreta do CoreDNS
- Problema com /etc/resolv.conf nos pods
- Certificados expirados do Kubernetes afetando CoreDNS
- Problema de rede entre pods e CoreDNS

========================================================
5. CONCLUSÃO
========================================================

DNS Status: NOK - DNS não está funcionando

Próximo passo: 
  NÃO prosseguir com E2E v3.7.2-nasp-fix FINAL até resolver DNS

Ações recomendadas:
1. Verificar configuração do /etc/resolv.conf nos pods
2. Verificar se CoreDNS está acessível na porta 53
3. Verificar certificados do Kubernetes (renovar se necessário)
4. Considerar usar IP direto como workaround temporário
5. Investigar logs do CoreDNS mais profundamente
6. Verificar configuração de rede do cluster (CNI)

Workaround temporário:
  - Modificar código SEM-CSMF para usar IP do service ao invés de DNS
  - Ou configurar DECISION_ENGINE_URL com IP direto via variável de ambiente

========================================================
