name: Root Protection

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  root-protection:
    name: Validate Root Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate root structure
        run: |
          echo "üîç Validando estrutura da raiz do reposit√≥rio..."
          echo ""
          
          # Arquivos permitidos na raiz
          ALLOWED_FILES=(
            "README.md"
            "LICENSE"
            ".gitignore"
            "CHANGELOG.md"
          )
          
          # Pastas permitidas na raiz
          ALLOWED_DIRS=(
            "helm"
            "ansible"
            "scripts"
            "docs"
            "monitoring"
            "tests"
            "apps"
            "configs"
            "nasp"
            "tools"
            ".github"
          )
          
          ERRORS=0
          FOUND_PROHIBITED=false
          
          # Listar todos os itens na raiz
          ROOT_ITEMS=$(find . -maxdepth 1 -not -path '*/\.*' -not -path '.' | sed 's|^\./||' | sort)
          
          echo "üìã Itens encontrados na raiz:"
          echo "$ROOT_ITEMS" | while read -r item; do
            echo "  - $item"
          done
          echo ""
          
          # Verificar cada item na raiz
          echo "üîç Verificando itens na raiz..."
          echo "$ROOT_ITEMS" | while read -r item; do
            # Pular se for diret√≥rio .git (n√£o aparece no find acima, mas por seguran√ßa)
            if [[ "$item" == ".git" ]]; then
              continue
            fi
            
            # Verificar se √© arquivo ou diret√≥rio
            if [ -f "$item" ]; then
              # √â um arquivo
              ALLOWED=false
              
              # Verificar se est√° na lista de permitidos
              for allowed in "${ALLOWED_FILES[@]}"; do
                if [[ "$item" == "$allowed" ]]; then
                  ALLOWED=true
                  break
                fi
              done
              
              if [ "$ALLOWED" = false ]; then
                echo "‚ùå ERRO: Arquivo proibido na raiz: $item"
                echo "   Arquivos permitidos na raiz: ${ALLOWED_FILES[*]}"
                FOUND_PROHIBITED=true
                ERRORS=$((ERRORS + 1))
              else
                echo "‚úÖ Arquivo permitido: $item"
              fi
              
            elif [ -d "$item" ]; then
              # √â um diret√≥rio
              ALLOWED=false
              
              # Verificar se est√° na lista de permitidos
              for allowed in "${ALLOWED_DIRS[@]}"; do
                if [[ "$item" == "$allowed" ]]; then
                  ALLOWED=true
                  break
                fi
              done
              
              if [ "$ALLOWED" = false ]; then
                echo "‚ùå ERRO: Diret√≥rio proibido na raiz: $item"
                echo "   Diret√≥rios permitidos na raiz: ${ALLOWED_DIRS[*]}"
                FOUND_PROHIBITED=true
                ERRORS=$((ERRORS + 1))
              else
                echo "‚úÖ Diret√≥rio permitido: $item"
              fi
            fi
          done
          
          echo ""
          
          # Verifica√ß√µes espec√≠ficas
          echo "üîç Verifica√ß√µes espec√≠ficas..."
          
          # Verificar arquivos .md na raiz (exceto README.md e CHANGELOG.md)
          MD_FILES=$(find . -maxdepth 1 -name "*.md" -not -name "README.md" -not -name "CHANGELOG.md" 2>/dev/null | sed 's|^\./||')
          if [ -n "$MD_FILES" ]; then
            echo "‚ùå ERRO: Arquivos .md proibidos na raiz (exceto README.md e CHANGELOG.md):"
            echo "$MD_FILES" | while read -r file; do
              echo "   - $file"
            done
            FOUND_PROHIBITED=true
            ERRORS=$((ERRORS + 1))
          else
            echo "‚úÖ Nenhum arquivo .md proibido na raiz"
          fi
          
          # Verificar arquivos .sh na raiz
          SH_FILES=$(find . -maxdepth 1 -name "*.sh" 2>/dev/null | sed 's|^\./||')
          if [ -n "$SH_FILES" ]; then
            echo "‚ùå ERRO: Arquivos .sh proibidos na raiz (devem estar em /scripts):"
            echo "$SH_FILES" | while read -r file; do
              echo "   - $file"
            done
            FOUND_PROHIBITED=true
            ERRORS=$((ERRORS + 1))
          else
            echo "‚úÖ Nenhum arquivo .sh na raiz"
          fi
          
          # Verificar arquivos .yaml/.yml na raiz (exceto se estiverem em pastas permitidas)
          YAML_FILES=$(find . -maxdepth 1 \( -name "*.yaml" -o -name "*.yml" \) 2>/dev/null | sed 's|^\./||')
          if [ -n "$YAML_FILES" ]; then
            echo "‚ùå ERRO: Arquivos .yaml/.yml proibidos na raiz (devem estar em /helm ou /configs):"
            echo "$YAML_FILES" | while read -r file; do
              echo "   - $file"
            done
            FOUND_PROHIBITED=true
            ERRORS=$((ERRORS + 1))
          else
            echo "‚úÖ Nenhum arquivo .yaml/.yml na raiz"
          fi
          
          # Verificar arquivos soltos (.txt, .log, .json)
          SOLO_FILES=$(find . -maxdepth 1 \( -name "*.txt" -o -name "*.log" -o -name "*.json" \) 2>/dev/null | sed 's|^\./||')
          if [ -n "$SOLO_FILES" ]; then
            echo "‚ùå ERRO: Arquivos soltos proibidos na raiz (.txt, .log, .json):"
            echo "$SOLO_FILES" | while read -r file; do
              echo "   - $file"
            done
            FOUND_PROHIBITED=true
            ERRORS=$((ERRORS + 1))
          else
            echo "‚úÖ Nenhum arquivo solto (.txt, .log, .json) na raiz"
          fi
          
          # Verificar pastas privadas
          PRIVATE_DIRS=$(find . -maxdepth 1 -type d \( -name "TriSLA_PROMPTS" -o -name "private" -o -name "sandbox" -o -name "tmp" -o -name "venv" -o -name ".venv" \) 2>/dev/null | sed 's|^\./||')
          if [ -n "$PRIVATE_DIRS" ]; then
            echo "‚ùå ERRO: Diret√≥rios privados detectados na raiz:"
            echo "$PRIVATE_DIRS" | while read -r dir; do
              echo "   - $dir"
            done
            FOUND_PROHIBITED=true
            ERRORS=$((ERRORS + 1))
          else
            echo "‚úÖ Nenhum diret√≥rio privado na raiz"
          fi
          
          echo ""
          
          # Resultado final
          if [ "$FOUND_PROHIBITED" = true ] || [ $ERRORS -gt 0 ]; then
            echo "::error::‚ùå ROOT inv√°lido: arquivos ou pastas n√£o permitidos foram detectados."
            echo ""
            echo "üìã Resumo:"
            echo "   - Erros encontrados: $ERRORS"
            echo "   - Arquivos permitidos na raiz: ${ALLOWED_FILES[*]}"
            echo "   - Diret√≥rios permitidos na raiz: ${ALLOWED_DIRS[*]}"
            echo ""
            echo "üîß A√ß√£o necess√°ria:"
            echo "   1. Mover arquivos proibidos para pastas apropriadas"
            echo "   2. Remover diret√≥rios privados"
            echo "   3. Executar: ./scripts/enforce-clean-root.sh"
            exit 1
          else
            echo "‚úÖ Estrutura da raiz v√°lida!"
            echo ""
            echo "üìã Estrutura permitida confirmada:"
            echo "   - Arquivos: ${ALLOWED_FILES[*]}"
            echo "   - Diret√≥rios: ${ALLOWED_DIRS[*]}"
          fi

