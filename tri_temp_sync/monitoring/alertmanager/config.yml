# ============================================
# Alertmanager Configuration - TriSLA
# ============================================

global:
  # Tempo de resolu√ß√£o para alertas duplicados
  resolve_timeout: 5m
  
  # Configura√ß√£o de email (exemplo - ajustar para produ√ß√£o)
  smtp_smarthost: 'abelisboa@gmail.com'
  smtp_from: 'abelisboa@gmail.com'
  smtp_auth_username: 'abelisboa@gmail.com'
  smtp_auth_password: 'Y000463a'
  smtp_require_tls: true

# Templates para notifica√ß√µes
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Roteamento de alertas
route:
  receiver: 'default'
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  
  routes:
    # Alertas cr√≠ticos - notifica√ß√£o imediata
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 1h
      continue: true
    
    # Alertas de warning - notifica√ß√£o com delay
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 6h
    
    # Alertas de m√≥dulos espec√≠ficos
    - match:
        component: grpc
      receiver: 'grpc-alerts'
      group_wait: 10s
    
    - match:
        component: database
      receiver: 'database-alerts'
      group_wait: 10s
    
    - match:
        component: sla
      receiver: 'sla-alerts'
      group_wait: 0s
      repeat_interval: 30m

# Inibi√ß√£o de alertas (evitar spam)
inhibit_rules:
  # Se m√∫ltiplos m√≥dulos est√£o down, apenas alertar sobre o problema geral
  - source_match:
      alertname: 'ModuleDown'
    target_match:
      alertname: 'MultipleModulesDown'
    equal: ['cluster']
  
  # Se CPU alto, n√£o alertar sobre mem√≥ria (pode ser relacionado)
  - source_match:
      alertname: 'HighCPUUsage'
    target_match:
      alertname: 'HighMemoryUsage'
    equal: ['job']

# Receivers (destinos das notifica√ß√µes)
receivers:
  # Receiver padr√£o
  - name: 'default'
    email_configs:
      - to: 'admin@example.com'
        send_resolved: true
        html: '{{ template "email.default.html" . }}'
        headers:
          Subject: '[TriSLA] {{ .GroupLabels.alertname }}'
  
  # Alertas cr√≠ticos
  - name: 'critical-alerts'
    email_configs:
      - to: 'ops-team@example.com'
        send_resolved: true
        html: '{{ template "email.critical.html" . }}'
        headers:
          Subject: '[TriSLA CRITICAL] {{ .GroupLabels.alertname }}'
    # Slack (opcional)
    # slack_configs:
    #   - api_url: '${SLACK_WEBHOOK_URL}'
    #     channel: '#trisla-critical'
    #     title: 'üö® Critical Alert'
    #     text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    #     send_resolved: true
  
  # Alertas de warning
  - name: 'warning-alerts'
    email_configs:
      - to: 'dev-team@example.com'
        send_resolved: true
        html: '{{ template "email.warning.html" . }}'
        headers:
          Subject: '[TriSLA WARNING] {{ .GroupLabels.alertname }}'
  
  # Alertas gRPC
  - name: 'grpc-alerts'
    email_configs:
      - to: 'grpc-team@example.com'
        send_resolved: true
        html: '{{ template "email.default.html" . }}'
        headers:
          Subject: '[TriSLA gRPC] {{ .GroupLabels.alertname }}'
  
  # Alertas de banco de dados
  - name: 'database-alerts'
    email_configs:
      - to: 'dba-team@example.com'
        send_resolved: true
        html: '{{ template "email.default.html" . }}'
        headers:
          Subject: '[TriSLA Database] {{ .GroupLabels.alertname }}'
  
  # Alertas de SLA
  - name: 'sla-alerts'
    email_configs:
      - to: 'sla-team@example.com'
        send_resolved: true
        html: '{{ template "email.critical.html" . }}'
        headers:
          Subject: '[TriSLA SLA VIOLATION] {{ .GroupLabels.alertname }}'
    # PagerDuty (opcional)
    # pagerduty_configs:
    #   - service_key: '${PAGERDUTY_SERVICE_KEY}'
    #     description: '{{ .GroupLabels.alertname }}: {{ .CommonAnnotations.description }}'

