---
# ============================================
# Playbook: Pré-Flight Checks
# ============================================
# Validações completas antes do deploy
# ============================================

- name: Pré-Flight Checks TriSLA
  hosts: nasp
  connection: local
  become: yes
  gather_facts: no
  
  vars:
    namespace: "{{ trisla.namespace }}"
  
  tasks:
    - name: Verificar versão do Kubernetes
      command: kubectl version --client --short
      register: k8s_version
      changed_when: false
    
    - name: Exibir versão do Kubernetes
      debug:
        msg: "{{ k8s_version.stdout }}"
    
    - name: Verificar certificados do cluster
      uri:
        url: "{{ kubeconfig_path | default('/etc/kubernetes/admin.conf') }}"
        method: GET
      delegate_to: localhost
      failed_when: false
      register: cert_check
    
    - name: Verificar DNS interno
      kubernetes.core.k8s:
        name: test-dns-{{ ansible_date_time.epoch }}
        namespace: default
        api_version: v1
        kind: Pod
        state: present
        definition:
          spec:
            containers:
              - name: test-dns
                image: busybox
                command: ['nslookup', 'kubernetes.default']
            restartPolicy: Never
      register: dns_test
      failed_when: false
    
    - name: Verificar resultado do DNS
      debug:
        msg: "DNS test: {{ dns_test.msg }}"
    
    - name: Limpar pod de teste DNS
      kubernetes.core.k8s:
        name: "{{ item }}"
        namespace: default
        state: absent
      loop: "{{ dns_test | default({}) | json_query('resources[*].metadata.name') | default([]) }}"
      when: dns_test is defined
      failed_when: false
    
    - name: Verificar autenticação GHCR
      command: echo "{{ GHCR_TOKEN | default('') }}" | docker login ghcr.io -u "{{ GHCR_USER | default('') }}" --password-stdin
      register: ghcr_login
      changed_when: false
      failed_when: false
      when: GHCR_TOKEN is defined and GHCR_USER is defined
    
    - name: Verificar suporte a NetworkPolicy
      command: kubectl api-resources | grep networkpolicies
      register: np_check
      changed_when: false
      failed_when: false
    
    - name: Verificar saúde do Calico
      command: kubectl get pods -n kube-system -l k8s-app=calico-node -o json
      register: calico_pods
      changed_when: false
      failed_when: false
    
    - name: Analisar pods do Calico
      set_fact:
        calico_total: "{{ calico_pods.stdout | from_json | json_query('items | length(@)') | default(0) }}"
        calico_ready: "{{ calico_pods.stdout | from_json | json_query('items[?status.phase==`Running`] | length(@)') | default(0) }}"
      when: calico_pods.rc == 0
    
    - name: Exibir status do Calico
      debug:
        msg: "Calico: {{ calico_ready | default(0) }}/{{ calico_total | default(0) }} pods Running"
      when: calico_pods.rc == 0
    
    - name: Verificar Helm
      command: helm version --short
      register: helm_version
      changed_when: false
      failed_when: false
    
    - name: Exibir versão do Helm
      debug:
        msg: "{{ helm_version.stdout }}"
      when: helm_version.rc == 0
    
    - name: Verificar StorageClass
      command: kubectl get storageclass -o json
      register: storage_classes
      changed_when: false
      failed_when: false
    
    - name: Contar StorageClasses
      set_fact:
        sc_count: "{{ storage_classes.stdout | from_json | json_query('items | length(@)') | default(0) }}"
      when: storage_classes.rc == 0
    
    - name: Exibir StorageClasses
      debug:
        msg: "{{ sc_count | default(0) }} StorageClass(es) encontrado(s)"
      when: storage_classes.rc == 0
    
    - name: Verificar namespace
      command: kubectl get namespace {{ namespace }}
      register: ns_check
      changed_when: false
      failed_when: false
    
    - name: Resumo do pré-flight
      debug:
        msg: |
          Pré-Flight Check Completo:
          - Kubernetes: {{ k8s_version.stdout_lines[0] | default('N/A') }}
          - Helm: {{ helm_version.stdout | default('N/A') }}
          - Calico: {{ calico_ready | default('N/A') }}/{{ calico_total | default('N/A') }} pods
          - StorageClass: {{ sc_count | default(0) }}
          - Namespace: {{ 'Existe' if ns_check.rc == 0 else 'Não existe' }}

