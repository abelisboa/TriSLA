---
# ============================================
# Playbook: Deploy TriSLA no NASP
# ============================================
# Deploy completo do TriSLA no ambiente NASP em produção real
# ============================================

- name: Deploy TriSLA no NASP (Produção Real)
  hosts: control_plane
  become: yes
  gather_facts: yes
  
  vars:
    namespace: "{{ trisla_namespace | default('trisla') }}"
    helm_chart_path: "{{ trisla_helm_chart_path | default('./helm/trisla') }}"
    values_file: "{{ helm_chart_path }}/values-production.yaml"
  
  tasks:
    - name: Verificar se namespace existe
      command: kubectl get namespace {{ namespace }}
      register: ns_check
      changed_when: false
      failed_when: false
    
    - name: Criar namespace se não existir
      kubernetes.core.k8s:
        name: "{{ namespace }}"
        api_version: v1
        kind: Namespace
        state: present
      when: ns_check.rc != 0
    
    - name: Adicionar repositório Helm (se necessário)
      command: helm repo add trisla {{ trisla_image_registry }}
      when: false  # Ajustar conforme necessário
    
    - name: Atualizar repositórios Helm
      command: helm repo update
      when: false  # Ajustar conforme necessário
    
    - name: Validar Helm chart
      command: helm lint {{ helm_chart_path }}
      register: helm_lint
      changed_when: false
    
    - name: Exibir resultado do lint
      debug:
        msg: "{{ helm_lint.stdout_lines }}"
    
    - name: Dry-run do deploy
      command: >
        helm install trisla {{ helm_chart_path }}
        --namespace {{ namespace }}
        --values {{ values_file }}
        --dry-run
        --debug
      register: helm_dry_run
      changed_when: false
    
    - name: Verificar se values-production.yaml existe
      stat:
        path: "{{ values_file }}"
      register: values_file_stat
    
    - name: Falhar se values-production.yaml não existir
      fail:
        msg: "Arquivo values-production.yaml não encontrado: {{ values_file }}. Execute scripts/fill_values_production.sh primeiro."
      when: not values_file_stat.stat.exists
    
    - name: Deploy real do TriSLA
      command: >
        helm upgrade --install trisla {{ helm_chart_path }}
        --namespace {{ namespace }}
        --values {{ values_file }}
        --create-namespace
        --wait
        --timeout 10m
      register: helm_deploy
      args:
        chdir: "{{ project_root | default('.') }}"
    
    - name: Verificar status do deploy
      command: kubectl get pods -n {{ namespace }}
      register: pods_status
      changed_when: false
      until: pods_status.rc == 0
      retries: 10
      delay: 30
    
    - name: Exibir status dos pods
      debug:
        msg: "{{ pods_status.stdout_lines }}"
    
    - name: Aguardar pods estarem prontos
      command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=trisla -n {{ namespace }} --timeout=600s
      register: wait_result
      failed_when: wait_result.rc != 0
    
    - name: Verificar serviços
      command: kubectl get svc -n {{ namespace }}
      register: svc_status
      changed_when: false
    
    - name: Exibir serviços
      debug:
        msg: "{{ svc_status.stdout_lines }}"
    
    - name: Validar deploy
      include_tasks: validate-deploy.yml

