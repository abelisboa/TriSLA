services:
  # ============================================
  # Database (PostgreSQL)
  # ============================================
  postgres:
    image: postgres:15-alpine
    container_name: trisla-postgres
    environment:
      POSTGRES_DB: trisla
      POSTGRES_USER: trisla
      POSTGRES_PASSWORD: trisla_password
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - trisla-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trisla"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Kafka (Message Broker)
  # ============================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: trisla-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - trisla-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: trisla-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    ports:
      - "29092:9092"
    networks:
      - trisla-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # Observability Stack
  # ============================================
  otlp-collector:
    build:
      context: ./monitoring/otel-collector
      dockerfile: Dockerfile
    container_name: trisla-otlp-collector
    ports:
      - "4317:4317"  # gRPC
      - "4318:4318"  # HTTP
    volumes:
      - ./monitoring/otel-collector/config.yaml:/etc/otelcol/config.yaml
    networks:
      - trisla-network
    command: ["--config=/etc/otelcol/config.yaml"]
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep otelcol || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  prometheus:
    image: prom/prometheus:latest
    container_name: trisla-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./monitoring/prometheus/rules:/etc/prometheus/rules
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - trisla-network
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:9090/-/healthy || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # Alertmanager
  # ============================================
  alertmanager:
    image: prom/alertmanager:latest
    container_name: trisla-alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager/config.yml:/etc/alertmanager/config.yml:ro
      - ./monitoring/alertmanager/templates:/etc/alertmanager/templates:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9093'
    networks:
      - trisla-network
    depends_on:
      prometheus:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  grafana:
    image: grafana/grafana:latest
    container_name: trisla-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - grafana-data:/var/lib/grafana
    networks:
      - trisla-network
    depends_on:
      prometheus:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:3000/api/health || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ============================================
  # TriSLA Modules
  # ============================================
  sem-csmf:
    build:
      context: ./apps/sem-csmf
      dockerfile: Dockerfile
    container_name: trisla-sem-csmf
    ports:
      - "8080:8080"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - OTLP_ENDPOINT=http://otlp-collector:4317
      - LOG_LEVEL=INFO
      - DATABASE_URL=postgresql://trisla:trisla_password@postgres:5432/trisla
      - DECISION_ENGINE_GRPC=decision-engine:50051
      - ENABLE_AUTH=true
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-trisla-secret-key-change-in-production}
      - RATE_LIMIT_ENABLED=true
    networks:
      - trisla-network
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
      otlp-collector:
        condition: service_started
      decision-engine:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/health', timeout=2)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  ml-nsmf:
    build:
      context: ./apps/ml-nsmf
      dockerfile: Dockerfile
    container_name: trisla-ml-nsmf
    ports:
      - "8081:8081"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - OTLP_ENDPOINT=http://otlp-collector:4317
      - LOG_LEVEL=INFO
    networks:
      - trisla-network
    depends_on:
      kafka:
        condition: service_healthy
      otlp-collector:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8081/health', timeout=2)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  decision-engine:
    build:
      context: ./apps/decision-engine
      dockerfile: Dockerfile
    container_name: trisla-decision-engine
    ports:
      - "8082:8082"  # FastAPI REST
      - "50051:50051"  # gRPC I-01
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - OTLP_ENDPOINT=http://otlp-collector:4317
      - LOG_LEVEL=INFO
      - GRPC_PORT=50051
    networks:
      - trisla-network
    depends_on:
      kafka:
        condition: service_healthy
      otlp-collector:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8082/health', timeout=2)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  bc-nssmf:
    build:
      context: ./apps/bc-nssmf
      dockerfile: Dockerfile
    container_name: trisla-bc-nssmf
    ports:
      - "8083:8083"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - OTLP_ENDPOINT=http://otlp-collector:4317
      - LOG_LEVEL=INFO
      - BLOCKCHAIN_NETWORK=local
      - BESU_RPC_URL=http://besu-dev:8545
      - BESU_CHAIN_ID=1337
    networks:
      - trisla-network
    depends_on:
      kafka:
        condition: service_healthy
      otlp-collector:
        condition: service_started
      besu-dev:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8083/health', timeout=2)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  sla-agent-layer:
    build:
      context: ./apps/sla-agent-layer
      dockerfile: Dockerfile
    container_name: trisla-sla-agent-layer
    ports:
      - "8084:8084"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - OTLP_ENDPOINT=http://otlp-collector:4317
      - LOG_LEVEL=INFO
    networks:
      - trisla-network
    depends_on:
      kafka:
        condition: service_healthy
      otlp-collector:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8084/health', timeout=2)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  nasp-adapter:
    build:
      context: ./apps/nasp-adapter
      dockerfile: Dockerfile
    container_name: trisla-nasp-adapter
    ports:
      - "8085:8085"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - OTLP_ENDPOINT=http://otlp-collector:4317
      - LOG_LEVEL=INFO
      # Modo MOCK para desenvolvimento local (NASP real apenas no node1)
      - NASP_MODE=mock
      - NASP_RAN_ENDPOINT=http://mock-nasp-ran:80
      - NASP_TRANSPORT_ENDPOINT=http://mock-nasp-transport:80
      - NASP_CORE_ENDPOINT=http://mock-nasp-core:80
    networks:
      - trisla-network
    depends_on:
      kafka:
        condition: service_healthy
      otlp-collector:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8085/health', timeout=2)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Mock NASP Services (apenas para desenvolvimento local)
  mock-nasp-ran:
    image: nginx:alpine
    container_name: trisla-mock-nasp-ran
    ports:
      - "8086:80"
    networks:
      - trisla-network
    command: >
      sh -c "echo 'server {
        listen 80;
        location /api/v1/metrics {
          default_type application/json;
          return 200 \"{\\\"cpu\\\": 45.2, \\\"memory\\\": 60.1, \\\"throughput\\\": 1.2}\";
        }
        location /health {
          return 200 \"OK\";
        }
      }' > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  mock-nasp-transport:
    image: nginx:alpine
    container_name: trisla-mock-nasp-transport
    ports:
      - "8087:80"
    networks:
      - trisla-network
    command: >
      sh -c "echo 'server {
        listen 80;
        location /api/v1/metrics {
          default_type application/json;
          return 200 \"{\\\"bandwidth\\\": 10.5, \\\"latency\\\": 5.2, \\\"jitter\\\": 0.8}\";
        }
        location /health {
          return 200 \"OK\";
        }
      }' > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  mock-nasp-core:
    image: nginx:alpine
    container_name: trisla-mock-nasp-core
    ports:
      - "8088:80"
    networks:
      - trisla-network
    command: >
      sh -c "echo 'server {
        listen 80;
        location /api/v1/metrics {
          default_type application/json;
          return 200 \"{\\\"connections\\\": 1250, \\\"packets_per_sec\\\": 5000, \\\"error_rate\\\": 0.01}\";
        }
        location /health {
          return 200 \"OK\";
        }
      }' > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  # ============================================
  # Blockchain (Besu / GoQuorum)
  # ============================================
  besu-dev:
    image: hyperledger/besu:latest
    container_name: trisla-besu-dev
    command:
      - "--network=dev"
      - "--rpc-http-enabled=true"
      - "--rpc-http-port=8545"
      - "--rpc-http-host=0.0.0.0"
      - "--rpc-http-api=ETH,NET,WEB3"
      - "--rpc-http-cors-origins=*"
      - "--rpc-http-hosts=*"
      - "--host-allowlist=*"
    ports:
      - "8545:8545"
    volumes:
      - besu-data:/opt/besu/data
      - ./blockchain/besu/genesis.json:/genesis.json:ro
    networks:
      - trisla-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8545 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # ============================================
  # UI Dashboard
  # ============================================
  ui-dashboard:
    build:
      context: ./apps/ui-dashboard
      dockerfile: Dockerfile
    container_name: trisla-ui-dashboard
    ports:
      - "80:80"
    environment:
      - REACT_APP_API_BASE_URL=http://localhost:8080
      - REACT_APP_PROMETHEUS_URL=http://localhost:9090
      - REACT_APP_GRAFANA_URL=http://localhost:3000
    networks:
      - trisla-network
    depends_on:
      - sem-csmf
      - prometheus
      - grafana
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:80 || exit 0"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

networks:
  trisla-network:
    driver: bridge

volumes:
  postgres-data:
  prometheus-data:
  grafana-data:
  alertmanager-data:
  besu-data:

